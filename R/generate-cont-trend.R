#' Generate the continental trend
#'
#' \code{generate_cont_trend} calculates the geometric mean annual changes in population size.
#'
#' @param indices Continental indices generated by \code{generate_cont_indices}
#' @param min_year Minimum year to calculate trends from
#' @param max_year Maximum year to calculate trends to
#' @param quantiles vector of quantiles to be sampled from the posterior distribution Defaults to c(0.025,0.05,0.25,0.5,0.75,0.95,0.975)
#' @param slope Logical, if TRUE, calculates an alternative trend metric, the slope of a log-linear regression through the annual indices. Default FALSE
#'
#' @return Numeric percentage of trend
#'
#' @examples
#'
#' \dontrun{
#' # Run a JAGS model analysis on a species
#' stratified_data <- stratify(bbs_data = fetch_bbs_data(), stratify_by = "bcr")
#' prepped_data <- prepare_jags_data(strat_data = stratified_data,
#'                                   species_to_run = "Wood Thrush",
#'                                   model = "slope")
#' mod <- run_model(jags_data = prepped_data)
#'
#' #Generate the continental indices weighted by each strata
#' cont_index <- generate_cont_indices(jags_mod = mod)
#'
#' #Output the trend
#' generate_cont_trend(indices = cont_index)
#' }
#'
#' @export
#'

generate_cont_trend <- function(indices = NULL,
                                min_year = NULL,
                                max_year = NULL,
                                quantiles = c(0.025,0.05,0.25,0.75,0.95,0.975),
                                slope = FALSE)
{
  if (is.null(indices))
  {
    stop("No indices supplied to generate_cont_trend()."); return(NULL)
  }
  n = indices$samples

  if (is.null(min_year))
  {
    min_year = indices$y_min
  }
  if (is.null(max_year))
  {
    max_year = indices$y_max
  }

if(slope){

    wy = c(min_year:max_year)
    ne = log(n[,wy])
    m = t(apply(ne,1,FUN = function(x) lm(x~wy)$coef)) #t(apply(x, 2, function(x.col) lm(y~x.col)$coef))
  sl.t = as.vector((exp(m[,"wy"])-1)*100)

}

  ch = n[,max_year]/n[,min_year]
  tr = 100*((ch^(1/(max_year-min_year)))-1)

  trend <- data.frame(Start_year = (indices$startyear+min_year)-1,
                              End_year = (indices$startyear+max_year)-1,
                      Region = "Continental",
                      Trend = median(tr),
                      stringsAsFactors = F)
  for(qq in quantiles){
  trend[,paste0("Trend_Q",qq)] <- quantile(tr,qq,names = F)
  }
  trend[,"Percent_Change"] <- median(ch)
  for(qq in quantiles){
    trend[,paste0("Percent_Change_Q",qq)] <- 100*(quantile(ch,qq,names = F)-1)
  }

  if(slope){
  trend[,"Slope_Trend"] <- median(sl.t)
  for(qq in quantiles){
    trend[,paste0("Slope_Trend_Q",qq)] <- quantile(sl.t,qq,names = F)
  }
  }

  return(trend)
}
